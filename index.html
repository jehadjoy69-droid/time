<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>রমজানের সময় - বাংলাদেশ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;500;700&family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans Bengali', 'Hind Siliguri', sans-serif; background: linear-gradient(135deg, #0a001f, #1e003c, #000814); color: #e0e0ff; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    h1 { font-size: 2.8rem; margin: 20px 0 10px; color: #ffd700; text-shadow: 0 0 15px #ffd70088; }
    .subtitle { font-size: 1.2rem; opacity: 0.9; margin-bottom: 25px; }
    .card { background: rgba(20, 20, 60, 0.7); backdrop-filter: blur(10px); border-radius: 20px; padding: 35px 25px; width: 100%; max-width: 480px; box-shadow: 0 15px 50px rgba(0,0,0,0.7); border: 1px solid #ffd70044; text-align: center; }
    label { font-size: 1.2rem; display: block; margin-bottom: 12px; color: #ffd700; }
    select { width: 100%; padding: 14px; font-size: 1.1rem; background: rgba(40,40,80,0.8); color: white; border: 1px solid #ffd700; border-radius: 10px; margin: 15px 0 25px; cursor: pointer; }
    .time-box { background: rgba(40,40,80,0.5); border-radius: 14px; padding: 20px; margin: 15px 0; border: 1px solid #ffd70033; }
    .label { font-size: 1.4rem; color: #ffd700; margin-bottom: 6px; font-weight: 500; }
    .time { font-size: 2.8rem; font-weight: bold; color: white; text-shadow: 0 0 12px #ffd700aa; }
    .date-info, .status { margin: 15px 0; font-size: 1.1rem; color: #ffcc00; opacity: 0.9; }
    footer { margin-top: 35px; font-size: 0.9rem; opacity: 0.8; text-align: center; }
    @media (max-width: 480px) { h1 { font-size: 2.4rem; } .time { font-size: 2.4rem; } .card { padding: 25px 18px; } }
  </style>
</head>
<body>

  <h1>রমজানের সময়</h1>
  <p class="subtitle">আজকের সেহরি ও ইফতার</p>

  <div class="card">
    <label for="district">জেলা নির্বাচন করুন</label>
    <select id="district">
      <option value="">জেলা বেছে নিন</option>

      <optgroup label="বরিশাল বিভাগ">
        <option value="Barguna">বরগুনা</option>
        <option value="Barisal">বরিশাল</option>
        <option value="Bhola">ভোলা</option>
        <option value="Jhalokati">ঝালকাঠি</option>
        <option value="Patuakhali">পটুয়াখালী</option>
        <option value="Pirojpur">পিরোজপুর</option>
      </optgroup>

      <optgroup label="চট্টগ্রাম বিভাগ">
        <option value="Bandarban">বান্দরবান</option>
        <option value="Brahmanbaria">ব্রাহ্মণবাড়িয়া</option>
        <option value="Chandpur">চাঁদপুর</option>
        <option value="Chattogram">চট্টগ্রাম</option>
        <option value="Cox's Bazar">কক্সবাজার</option>
        <option value="Cumilla">কুমিল্লা</option>
        <option value="Feni">ফেনী</option>
        <option value="Khagrachhari">খাগড়াছড়ি</option>
        <option value="Lakshmipur">লক্ষ্মীপুর</option>
        <option value="Noakhali">নোয়াখালী</option>
        <option value="Rangamati">রাঙ্গামাটি</option>
      </optgroup>

      <optgroup label="ঢাকা বিভাগ">
        <option value="Dhaka">ঢাকা</option>
        <option value="Faridpur">ফরিদপুর</option>
        <option value="Gazipur">গাজীপুর</option>
        <option value="Gopalganj">গোপালগঞ্জ</option>
        <option value="Kishoreganj">কিশোরগঞ্জ</option>
        <option value="Madaripur">মাদারীপুর</option>
        <option value="Manikganj">মানিকগঞ্জ</option>
        <option value="Munshiganj">মুন্সীগঞ্জ</option>
        <option value="Narayanganj">নারায়ণগঞ্জ</option>
        <option value="Narsingdi">নরসিংদী</option>
        <option value="Rajbari">রাজবাড়ী</option>
        <option value="Shariatpur">শরীয়তপুর</option>
        <option value="Tangail">টাঙ্গাইল</option>
      </optgroup>

      <optgroup label="খুলনা বিভাগ">
        <option value="Bagerhat">বাগেরহাট</option>
        <option value="Chuadanga">চুয়াডাঙ্গা</option>
        <option value="Jashore">যশোর</option>
        <option value="Jhenaidah">ঝিনাইদহ</option>
        <option value="Khulna">খুলনা</option>
        <option value="Kushtia">কুষ্টিয়া</option>
        <option value="Magura">মাগুরা</option>
        <option value="Meherpur">মেহেরপুর</option>
        <option value="Narail">নড়াইল</option>
        <option value="Satkhira">সাতক্ষীরা</option>
      </optgroup>

      <optgroup label="ময়মনসিংহ বিভাগ">
        <option value="Jamalpur">জামালপুর</option>
        <option value="Mymensingh">ময়মনসিংহ</option>
        <option value="Netrokona">নেত্রকোনা</option>
        <option value="Sherpur">শেরপুর</option>
      </optgroup>

      <optgroup label="রাজশাহী বিভাগ">
        <option value="Bogura">বগুড়া</option>
        <option value="Chapainawabganj">চাঁপাইনবাবগঞ্জ</option>
        <option value="Joypurhat">জয়পুরহাট</option>
        <option value="Naogaon">নওগাঁ</option>
        <option value="Natore">নাটোর</option>
        <option value="Pabna">পাবনা</option>
        <option value="Rajshahi">রাজশাহী</option>
        <option value="Sirajganj">সিরাজগঞ্জ</option>
      </optgroup>

      <optgroup label="রংপুর বিভাগ">
        <option value="Dinajpur">দিনাজপুর</option>
        <option value="Gaibandha">গাইবান্ধা</option>
        <option value="Kurigram">কুড়িগ্রাম</option>
        <option value="Lalmonirhat">লালমনিরহাট</option>
        <option value="Nilphamari">নীলফামারী</option>
        <option value="Panchagarh">পঞ্চগড়</option>
        <option value="Rangpur">রংপুর</option>
        <option value="Thakurgaon">ঠাকুরগাঁও</option>
      </optgroup>

      <optgroup label="সিলেট বিভাগ">
        <option value="Habiganj">হবিগঞ্জ</option>
        <option value="Maulvibazar">মৌলভীবাজার</option>
        <option value="Sunamganj">সুনামগঞ্জ</option>
        <option value="Sylhet">সিলেট</option>
      </optgroup>
    </select>

    <div id="todayDate" class="date-info">আজকের তারিখ লোড হচ্ছে...</div>

    <div class="time-box">
      <div class="label">সেহরি শেষ</div>
      <div id="sehri" class="time">—</div>
    </div>

    <div class="time-box">
      <div class="label">ইফতার</div>
      <div id="iftar" class="time">—</div>
    </div>

    <div id="status" class="status">লোকেশন চেক হচ্ছে...</div>
  </div>

  <footer>Developed by Jehad Joy</footer>

  <script>
    const districtSelect = document.getElementById('district');
    const sehriEl = document.getElementById('sehri');
    const iftarEl = document.getElementById('iftar');
    const dateEl = document.getElementById('todayDate');
    const statusEl = document.getElementById('status');

    // Date setup
    const today = new Date();
    const banglaMonths = ["জানুয়ারি", "ফেব্রুয়ারি", "মার্চ", "এপ্রিল", "মে", "জুন", "জুলাই", "আগস্ট", "সেপ্টেম্বর", "অক্টোবর", "নভেম্বর", "ডিসেম্বর"];
    const banglaDays = ["রবিবার", "সোমবার", "মঙ্গলবার", "বুধবার", "বৃহস্পতিবার", "শুক্রবার", "শনিবার"];
    dateEl.textContent = today.getDate() + " " + banglaMonths[today.getMonth()] + ", " + today.getFullYear() + " • " + banglaDays[today.getDay()];

    function fetchTimes(district) {
      if (!district) return;
      district = district.trim().replace(/ District/gi, '');
      if (district.toLowerCase().includes('kusht') || district.toLowerCase().includes('কুষ্টিয়া')) district = 'Kushtia';

      statusEl.textContent = 'সময় লোড হচ্ছে...';
      fetch(`/api/ramadan?location=${encodeURIComponent(district)}`)
        .then(res => res.ok ? res.json() : Promise.reject('API error'))
        .then(data => {
          if (data.today?.sehri_end && data.today?.iftar) {
            sehriEl.textContent = data.today.sehri_end;
            iftarEl.textContent = data.today.iftar;
            statusEl.textContent = 'লোকেশন: ' + (data.name || district);
          } else {
            statusEl.textContent = 'তথ্য পাওয়া যায়নি';
          }
        })
        .catch(() => statusEl.textContent = 'লোডে সমস্যা হয়েছে');
    }

    // Auto geolocation on page load (prompt if not granted)
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&zoom=10`)
            .then(res => res.json())
            .then(loc => {
              let dist = loc.address.state_district || loc.address.city || loc.address.town || loc.address.village || '';
              dist = dist.replace(/ District| Division/gi, '').trim();
              if (dist.toLowerCase().includes('kushtia')) dist = 'Kushtia';
              districtSelect.value = dist;
              fetchTimes(dist);
              statusEl.textContent = 'অটো লোকেশন: ' + dist;
            })
            .catch(() => fallbackToIP());
        },
        err => {
          statusEl.textContent = err.code === 1 ? 'লোকেশন অনুমতি দেননি' : 'লোকেশন পাওয়া যায়নি';
          fallbackToIP();
        },
        { timeout: 10000, maximumAge: 60000 }  // 10s timeout, cache 1 min
      );
    } else {
      fallbackToIP();
    }

    function fallbackToIP() {
      fetch('https://ipapi.co/json/')
        .then(res => res.json())
        .then(data => {
          if (data.country_name === 'Bangladesh') {
            let detected = data.city || data.region || '';
            if (detected.toLowerCase().includes('kushtia')) detected = 'Kushtia';
            if (detected) {
              districtSelect.value = detected;
              fetchTimes(detected);
              statusEl.textContent = 'IP থেকে: ' + detected;
            }
          }
        })
        .catch(() => statusEl.textContent = 'লোকেশন ডিটেক্ট করা যায়নি - জেলা বেছে নিন');
    }

    districtSelect.addEventListener('change', e => fetchTimes(e.target.value));

    // Initial load with Kushtia fallback
    fetchTimes('Kushtia');
  </script>
</body>
</html>
